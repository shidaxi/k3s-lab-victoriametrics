apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheusalert
  namespace: monitor-system
data:
  prometheusalert.sql: |
    PRAGMA synchronous = OFF;
    PRAGMA journal_mode = MEMORY;
    BEGIN TRANSACTION;
    CREATE TABLE `prometheus_alert_d_b` (
      `id` integer NOT NULL PRIMARY KEY AUTOINCREMENT
    ,  `tpltype` varchar(255) NOT NULL DEFAULT ''
    ,  `tpluse` varchar(255) NOT NULL DEFAULT ''
    ,  `tplname` varchar(255) NOT NULL DEFAULT ''
    ,  `tpl` longtext NOT NULL
    ,  `created` datetime NOT NULL
    );
    INSERT INTO `prometheus_alert_d_b` VALUES ('3', 'fs', 'Prometheus', 'prometheus-fs', '{{ $var := .externalURL}}{{ range $k,$v:=.alerts }}
    {{if eq $v.status "resolved"}}
    **âœ…âœ…âœ…[Recover {{$v.labels.env}}]({{$v.generatorURL}})** *[{{$v.labels.alertname}}]({{$var}})*
    ![è­¦æŠ¥ å›¾æ ‡](https://i01piccdn.sogoucdn.com/2dbf8a9d48e921e7)
    **=====æ•…éšœå·²æ¢å¤=====**
    Levelï¼š**{{$v.labels.level}}**
    Severityï¼š**{{$v.labels.severity}}**
    Start atï¼š{{$v.startsAt}}
    End atï¼š{{$v.endsAt}}
    Owners: **{{$v.labels.owners}}**, OU: **{{$v.labels.ou}}**, Cluster: **{{$v.labels.cluster}}**, Env: **{{$v.labels.env}}**
    Instanceï¼š**{{$v.labels.instance}}**, Serviceï¼š**{{$v.labels.service}}**, Jobï¼š**{{$v.labels.job}}**
    Description: {{$v.annotations.description}}.
    {{else}}
    **ğŸ’¥ğŸ’¥ğŸ’¥[Alert {{$v.labels.env}}]({{$v.generatorURL}})** *[{{$v.labels.alertname}}]({{$var}})*
    **====ä¾¦æµ‹åˆ°æ•…éšœ====**
    Levelï¼š**{{$v.labels.level}}**
    Severityï¼š**{{$v.labels.severity}}**
    Start atï¼š{{$v.startsAt}}
    End atï¼š{{$v.endsAt}}
    Owners: **{{$v.labels.owners}}**, OU: **{{$v.labels.ou}}**, Cluster: **{{$v.labels.cluster}}**, Env: **{{$v.labels.env}}**
    Instanceï¼š**{{$v.labels.instance}}**, Serviceï¼š**{{$v.labels.service}}**, Jobï¼š**{{$v.labels.job}}**
    Description: {{$v.annotations.description}} 
    Link: **[Runbook]({{$v.annotations.runbook_url}})** | **[Grafana]({{$v.annotations.grafana_url}})**
    At: {{html $v.annotations.at}}
    {{end}}
    {{ end }}', '2020-12-22 03:07:39');
    INSERT INTO `prometheus_alert_d_b` VALUES ('4', 'fs', 'Prometheus', 'prometheus-elastalert-fs', '{{ $var := .externalURL}}{{ range $k,$v:=.alerts }}
    {{if eq $v.status "resolved"}}
    **âœ…âœ…âœ…[Recover {{$v.labels.env}}]({{$v.generatorURL}})** *[{{$v.labels.alertname}}]({{$var}})*
    ![è­¦æŠ¥ å›¾æ ‡](https://i01piccdn.sogoucdn.com/2dbf8a9d48e921e7)
    **=====æ•…éšœå·²æ¢å¤=====**
    Levelï¼š**{{$v.labels.level}}**
    Severityï¼š**{{$v.labels.severity}}**
    Start atï¼š{{$v.startsAt}}
    End atï¼š{{$v.endsAt}}
    Owners: **{{$v.labels.owners}}**, OU: **{{$v.labels.ou}}**, Env: **{{$v.labels.env}}**
    NumHitï¼š**{{$v.labels.num_hit}}**, AppNameï¼š**{{$v.labels.appname}}**, 
    Msgï¼š**{{$v.labels.msg}}**
    {{else}}
    **ğŸ’¥ğŸ’¥ğŸ’¥[Alert {{$v.labels.env}}]({{$v.generatorURL}})** *[{{$v.labels.alertname}}]({{$var}})*
    **====ä¾¦æµ‹åˆ°æ•…éšœ====**
    Levelï¼š**{{$v.labels.level}}**
    Severityï¼š**{{$v.labels.severity}}**
    Start atï¼š{{$v.startsAt}}
    End atï¼š{{$v.endsAt}}
    Owners: **{{$v.labels.owners}}**, OU: **{{$v.labels.ou}}**, Env: **{{$v.labels.env}}**
    NumHitï¼š**{{$v.labels.num_hit}}**, AppNameï¼š**{{$v.labels.appname}}**, 
    Msgï¼š**{{$v.labels.msg}}**
    Link: **[Runbook]({{$v.annotations.runbook_url}})** | **[Grafana]({{$v.annotations.grafana_url}})**
    At: {{html $v.annotations.at}}
    {{end}}
    {{ end }}', '2020-12-22 03:07:39');
    CREATE TABLE `alert_record` (
                                    `id` integer NOT NULL PRIMARY KEY AUTOINCREMENT
    ,                                `send_type` varchar(255) NOT NULL DEFAULT ''
    ,                                `alertname` varchar(255) NOT NULL DEFAULT ''
    ,                                `alert_level` varchar(255) NOT NULL DEFAULT ''
    ,                                `business_type` varchar(255) NOT NULL DEFAULT ''
    ,                                `instance` varchar(255) NOT NULL DEFAULT ''
    ,                                `starts_at` varchar(255) NOT NULL DEFAULT ''
    ,                                `ends_at` varchar(255) NOT NULL DEFAULT ''
    ,                                `summary` varchar(255) NOT NULL DEFAULT ''
    ,                                `description` varchar(255) NOT NULL DEFAULT ''
    ,                                `handle_status` varchar(255) NOT NULL DEFAULT ''
    ,                                `alert_status` varchar(255) NOT NULL DEFAULT ''
    ,                                `alert_json` varchar(255) NOT NULL DEFAULT ''
    ,                                `remark` varchar(255) NOT NULL DEFAULT ''
    ,                                `revision` integer NOT NULL DEFAULT '0'
    ,                                `created_by` varchar(255) NOT NULL DEFAULT ''
    ,                                `created_time` datetime NOT NULL
    ,                                `updated_by` varchar(255) NOT NULL DEFAULT ''
    ,                                `updated_time` datetime NOT NULL
    );
    CREATE INDEX "idx_prometheus_alert_d_b_prometheus_alert_d_b_tplname" ON "prometheus_alert_d_b" (`tplname`);
    END TRANSACTION;